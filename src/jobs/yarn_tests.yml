description: |
  This job performs tests (custom, unit, e2e) for the project.
docker:
  - image: cimg/node:<< parameters.node_version >>

parameters:
  node_version:
    type: string
    default: "18.18"
    description: Select the version of cimg/node
  prj_path:
    type: string
    default: ""
    description: Project path where package.json lies.

steps:
  - attach_workspace:
      at: ~/project
  - restore_cache:
      key: dependency-cache-{{ checksum "package.json" }}
  - run:
      name: Test
      command: |
        if [[ -n "$prj_path" ]]; then cd "$prj_path" fi
        yarn test
  - run:
      name: Unit Test
      command: |
        if [[ -n "$prj_path" ]]; then cd "$prj_path" fi
        yarn test:unit
  - run:
      name: E2E Test
      command: |
        if [[ -n "$prj_path" ]]; then cd "$prj_path" fi
        yarn test:e2e
  
  - save_cache:
      key: dependency-cache-{{ checksum "package.json" }}
      paths:
        - "*"
  - persist_to_workspace:
      root: ~/project
      paths:
        - "*"
